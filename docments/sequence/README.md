# サマリ
まずはAPPサーバの負担が少ない同期処理のフラグ管理で実装。
エンハンスで非同期処理もやりたいとかがあればAPPにも内部向けのAPIサーバを実装する。

# シーケンス図の検討
ここでは研究用サーバをAPPサーバと呼ぶ。

## 同期処理
まずは簡単な同期処理のAPIサーバを実装することを考える。
### APIサーバを分離する
#### 案１：APPサーバにもAPIサーバを実装する
基本的にはこれがベストプラクティスだが、研究室でやるには実装難易度がやや高い。
- 実装難易度：△
- 運用：〇
- 処理速度：〇

#### 案２：APIサーバとAPPサーバフラグ管理を行う 
APIの処理速度はいまいちだが、APPサーバの改修はほぼ不要で実装難易度が低い。
- 実装難易度：〇
- 運用：〇
- 処理速度：△

### APIサーバを分離しない
#### 案３：APPサーバをそのままAPIサーバ化する
研究室のメンバーでAPIサーバを実装する。APIサーバの改修でAPPサーバに影響が出やすい。APIサーバをスケールしにくい。
- 実装難易度：×
- 運用：×
- 処理速度：〇

## 非同期処理
商用向けにするのであればAPIサーバは非同期処理したいところ。
### 案４：APPサーバにもAPIサーバを実装する
ベストプラクティスだが、同期処理よりさらに難易度が上がる。
- 実装難易度：×
- 運用：〇
- 処理速度：〇
### 案５：APIサーバとAPPサーバフラグ管理を行う
- 実装難易度：×
- 運用：〇
- 処理速度：〇

# 非同期処理の検討
### 前提
1. APIがたたかれる頻度：30分に1回
2. 応答時間時間：1分~15分
3. 並列処理したいリクエスト数：？
### リクエストの管理方法
- リクエストIDをローカルの辞書で管理  
実装は楽だが、ローカルの容量を食うのでスケールができない。
リクエストは処理が終わるまで待たせて、レスポンスは処理結果を返す。
- backgroundタスク :star: 非同期をやるならこれがよさそう  
リクエストは即時応答してリクエストIDと処理状態のみ返却、処理結果は別のURIで取得させる。  
前提となる応答時間を踏まえるとこれがいい気がする。  
ユーザはレスポンスのデータをどう使うのか次第で、レスポンスの処理を自動化させたい人達にとっては使いにくくなる。  
結果を見たいだけならwebサーバで画面を作ってデータはそこからcsvなりJSONなりで出力してあげればいい気がする。  
APIとしてはrequestをjobkick用と結果取得用に分けて2回取得してもらうこともできる。  
- Queueを使う  
実装難易度が高い。管理が大変そう。
- DBを使う  
実装難易度が高い。管理が大変そう。

### 計算部分とAPIの分離
研究用サーバは同期処理しかできないので何らかの工夫が必要  
- 研究用サーバのmain.pyにAPIサーバを実装する  
ただでさえ重いコンテナにさらに機能を追加するのはつらい
- pythonを実行ファイル化してもらう  
インプット・アウトプットのファイルの管理がだるそう、開発コストが高すぎる。
- APIサーバからSSHで研究用サーバのmain.pyを叩きに行く  
応答速度を犠牲にすれば割とありかもしれない。
- 研究用サーバを複数建てる  
お金の力ですべてを解決できる